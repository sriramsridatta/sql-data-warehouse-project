-- Review silver customer info to verify NAS prefix handling in ERP data
SELECT * FROM silver.crm_cust_info cci ;

-- Flag birth dates that are implausibly old or in the future for data correction
SELECT DISTINCT eca.bdate
FROM erp_cust_az12 eca
WHERE eca.bdate < '1924-01-01' OR eca.bdate > now();

-- Examine unique gender values to prepare for standardization
SELECT DISTINCT eca.gen
FROM erp_cust_az12 eca ;

-- Transform and load ERP customer data, stripping NAS prefixes from IDs and normalizing gender values
INSERT  INTO silver.erp_cust_az12(
	cid ,
	bdate ,
	gen
)
SELECT
CASE WHEN eca.cid LIKE 'NAS%' THEN SUBSTRING(eca.cid, 4, length(eca.cid))
	ELSE eca.cid
END cid,
CASE WHEN eca.bdate > now() THEN NULL
	ELSE eca.bdate
END AS bdate,
CASE WHEN UPPER(TRIM(eca.gen)) IN ('F', 'Female') THEN 'Female'
	WHEN UPPER(TRIM(eca.gen)) IN ('M', 'Male') THEN 'Male'
	ELSE 'n/a'
END AS gen
FROM bronze.erp_cust_az12 eca ;